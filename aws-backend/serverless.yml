service: inventory-management-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  
  environment:
    USERS_TABLE: ${self:service}-users-${self:provider.stage}
    PRODUCTS_TABLE: ${self:service}-products-${self:provider.stage}
    STOCK_TABLE: ${self:service}-stock-${self:provider.stage}
    ORDERS_TABLE: ${self:service}-orders-${self:provider.stage}
    JWT_SECRET: ${env:JWT_SECRET, 'your-jwt-secret-key'}
    
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.USERS_TABLE}"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.USERS_TABLE}/index/*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.PRODUCTS_TABLE}"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.PRODUCTS_TABLE}/index/*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.STOCK_TABLE}"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.STOCK_TABLE}/index/*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.ORDERS_TABLE}"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.ORDERS_TABLE}/index/*"

functions:
  # Authentication functions
  register:
    handler: lambda/auth/handler.register
    events:
      - http:
          path: auth/register
          method: post
          cors: true

  login:
    handler: lambda/auth/handler.login
    events:
      - http:
          path: auth/login
          method: post
          cors: true

  getProfile:
    handler: lambda/auth/handler.getProfile
    events:
      - http:
          path: auth/profile
          method: get
          cors: true

  verifyToken:
    handler: lambda/auth/handler.verifyToken
    events:
      - http:
          path: auth/verify
          method: post
          cors: true

  # Product functions
  getProducts:
    handler: lambda/products/handler.getProducts
    events:
      - http:
          path: products
          method: get
          cors: true

  getProduct:
    handler: lambda/products/handler.getProduct
    events:
      - http:
          path: products/{productId}
          method: get
          cors: true

  createProduct:
    handler: lambda/products/handler.createProduct
    events:
      - http:
          path: products
          method: post
          cors: true

  updateProduct:
    handler: lambda/products/handler.updateProduct
    events:
      - http:
          path: products/{productId}
          method: put
          cors: true

  deleteProduct:
    handler: lambda/products/handler.deleteProduct
    events:
      - http:
          path: products/{productId}
          method: delete
          cors: true

  # Stock functions
  getStock:
    handler: lambda/stock/handler.getStock
    events:
      - http:
          path: stock
          method: get
          cors: true

  getStockByProduct:
    handler: lambda/stock/handler.getStockByProduct
    events:
      - http:
          path: stock/product/{productId}
          method: get
          cors: true

  addStock:
    handler: lambda/stock/handler.addStock
    events:
      - http:
          path: stock
          method: post
          cors: true

  updateStock:
    handler: lambda/stock/handler.updateStock
    events:
      - http:
          path: stock/{stockId}
          method: put
          cors: true

  dispatchStock:
    handler: lambda/stock/handler.dispatchStock
    events:
      - http:
          path: stock/{stockId}/dispatch
          method: post
          cors: true

  # Income/Orders functions
  getOrders:
    handler: lambda/income/handler.getOrders
    events:
      - http:
          path: orders
          method: get
          cors: true

  getOrdersByDateRange:
    handler: lambda/income/handler.getOrdersByDateRange
    events:
      - http:
          path: orders/range
          method: get
          cors: true

  createOrder:
    handler: lambda/income/handler.createOrder
    events:
      - http:
          path: orders
          method: post
          cors: true

  getIncomeSummary:
    handler: lambda/income/handler.getIncomeSummary
    events:
      - http:
          path: income/summary
          method: get
          cors: true

resources:
  Resources:
    # Users Table
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: EmailIndex
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST

    # Products Table
    ProductsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.PRODUCTS_TABLE}
        AttributeDefinitions:
          - AttributeName: productId
            AttributeType: S
          - AttributeName: category
            AttributeType: S
        KeySchema:
          - AttributeName: productId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: CategoryIndex
            KeySchema:
              - AttributeName: category
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST

    # Stock Table
    StockTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.STOCK_TABLE}
        AttributeDefinitions:
          - AttributeName: stockId
            AttributeType: S
          - AttributeName: productId
            AttributeType: S
          - AttributeName: location
            AttributeType: S
        KeySchema:
          - AttributeName: stockId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: ProductIndex
            KeySchema:
              - AttributeName: productId
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: LocationIndex
            KeySchema:
              - AttributeName: location
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST

    # Orders Table
    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ORDERS_TABLE}
        AttributeDefinitions:
          - AttributeName: orderId
            AttributeType: S
          - AttributeName: customerId
            AttributeType: S
          - AttributeName: orderDate
            AttributeType: S
        KeySchema:
          - AttributeName: orderId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: CustomerIndex
            KeySchema:
              - AttributeName: customerId
                KeyType: HASH
              - AttributeName: orderDate
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3000